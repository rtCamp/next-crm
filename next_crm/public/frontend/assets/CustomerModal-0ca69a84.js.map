{"version":3,"file":"CustomerModal-0ca69a84.js","sources":["../../../../frontend/src/components/Icons/MoneyIcon.vue","../../../../frontend/src/components/Icons/TerritoryIcon.vue","../../../../frontend/src/components/Modals/CustomerModal.vue"],"sourcesContent":["<template>\n  <svg\n    xmlns=\"http://www.w3.org/2000/svg\"\n    width=\"16\"\n    height=\"16\"\n    viewBox=\"0 0 24 24\"\n    fill=\"none\"\n    stroke=\"currentColor\"\n    stroke-width=\"1.5\"\n    stroke-linecap=\"round\"\n    stroke-linejoin=\"round\"\n    class=\"lucide lucide-circle-dollar-sign\"\n  >\n    <circle cx=\"12\" cy=\"12\" r=\"10\" />\n    <path d=\"M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8\" />\n    <path d=\"M12 18V6\" />\n  </svg>\n</template>\n","<template>\n  <svg\n    xmlns=\"http://www.w3.org/2000/svg\"\n    width=\"16\"\n    height=\"16\"\n    viewBox=\"0 0 24 24\"\n    fill=\"none\"\n    stroke=\"currentColor\"\n    stroke-width=\"1.5\"\n    stroke-linecap=\"round\"\n    stroke-linejoin=\"round\"\n    class=\"lucide lucide-land-plot\"\n  >\n    <path d=\"m12 8 6-3-6-3v10\" />\n    <path\n      d=\"m8 11.99-5.5 3.14a1 1 0 0 0 0 1.74l8.5 4.86a2 2 0 0 0 2 0l8.5-4.86a1 1 0 0 0 0-1.74L16 12\"\n    />\n    <path d=\"m6.49 12.85 11.02 6.3\" />\n    <path d=\"M17.51 12.85 6.5 19.15\" />\n  </svg>\n</template>\n","<template>\n  <Dialog v-model=\"show\" :options=\"dialogOptions\">\n    <template #body>\n      <div class=\"bg-white px-4 pb-6 pt-5 sm:px-6\">\n        <div class=\"mb-5 flex items-center justify-between\">\n          <div>\n            <h3 class=\"text-2xl font-semibold leading-6 text-gray-900\">\n              {{ __(dialogOptions.title) || __('Untitled') }}\n            </h3>\n          </div>\n          <div class=\"flex items-center gap-1\">\n            <Button\n              v-if=\"isManager() || detailMode\"\n              variant=\"ghost\"\n              class=\"w-7\"\n              @click=\"detailMode ? (detailMode = false) : openQuickEntryModal()\"\n            >\n              <EditIcon class=\"h-4 w-4\" />\n            </Button>\n            <Button variant=\"ghost\" class=\"w-7\" @click=\"show = false\">\n              <FeatherIcon name=\"x\" class=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n        <div>\n          <div v-if=\"detailMode\" class=\"flex flex-col gap-3.5\">\n            <div\n              class=\"flex h-7 items-center gap-2 text-base text-gray-800\"\n              v-for=\"field in fields\"\n              :key=\"field.name\"\n            >\n              <div class=\"grid w-7 place-content-center\">\n                <component :is=\"field.icon\" />\n              </div>\n              <div>{{ field.value }}</div>\n            </div>\n          </div>\n          <Fields\n            v-else-if=\"filteredSections\"\n            :sections=\"filteredSections\"\n            :data=\"_customer\"\n          />\n        </div>\n      </div>\n      <div v-if=\"!detailMode\" class=\"px-4 pb-7 pt-4 sm:px-6\">\n        <div class=\"space-y-2\">\n          <Button\n            class=\"w-full\"\n            v-for=\"action in dialogOptions.actions\"\n            :key=\"action.label\"\n            v-bind=\"action\"\n            :label=\"__(action.label)\"\n            :loading=\"loading\"\n          />\n        </div>\n      </div>\n    </template>\n  </Dialog>\n  <AddressModal v-model=\"showAddressModal\" v-model:address=\"_address\" />\n</template>\n\n<script setup>\nimport Fields from '@/components/Fields.vue'\nimport AddressModal from '@/components/Modals/AddressModal.vue'\nimport EditIcon from '@/components/Icons/EditIcon.vue'\nimport MoneyIcon from '@/components/Icons/MoneyIcon.vue'\nimport WebsiteIcon from '@/components/Icons/WebsiteIcon.vue'\nimport CustomersIcon from '@/components/Icons/CustomersIcon.vue'\nimport TerritoryIcon from '@/components/Icons/TerritoryIcon.vue'\nimport { usersStore } from '@/stores/users'\nimport { formatNumberIntoCurrency } from '@/utils'\nimport { capture } from '@/telemetry'\nimport { call, FeatherIcon, createResource } from 'frappe-ui'\nimport { ref, nextTick, watch, computed, h } from 'vue'\nimport { useRouter } from 'vue-router'\n\nconst props = defineProps({\n  options: {\n    type: Object,\n    default: {\n      redirect: true,\n      detailMode: false,\n      afterInsert: () => {},\n    },\n  },\n})\n\nconst { isManager } = usersStore()\n\nconst router = useRouter()\nconst show = defineModel()\nconst customer = defineModel('customer')\n\nconst loading = ref(false)\nconst title = ref(null)\nconst detailMode = ref(false)\nconst editMode = ref(false)\nlet _address = ref({})\nlet _customer = ref({\n  customer_name: '',\n  website: '',\n  annual_revenue: '',\n  no_of_employees: '1-10',\n  industry: '',\n})\n\nconst showAddressModal = ref(false)\n\nlet doc = ref({})\n\nasync function updateCustomer() {\n  const old = { ...doc.value }\n  const newOrg = { ..._customer.value }\n\n  const nameChanged = old.customer_name !== newOrg.customer_name\n  delete old.customer_name\n  delete newOrg.customer_name\n\n  const otherFieldChanged = JSON.stringify(old) !== JSON.stringify(newOrg)\n  const values = newOrg\n\n  if (!nameChanged && !otherFieldChanged) {\n    show.value = false\n    return\n  }\n\n  let name\n  loading.value = true\n  if (nameChanged) {\n    name = await callRenameDoc()\n  }\n  if (otherFieldChanged) {\n    name = await callSetValue(values)\n  }\n  handleCustomerUpdate({ name }, nameChanged)\n}\n\nasync function callRenameDoc() {\n  const d = await call('frappe.client.rename_doc', {\n    doctype: 'Customer',\n    old_name: doc.value?.customer_name,\n    new_name: _customer.value.customer_name,\n  })\n  loading.value = false\n  return d\n}\n\nasync function callSetValue(values) {\n  const d = await call('frappe.client.set_value', {\n    doctype: 'Customer',\n    name: _customer.value.name,\n    fieldname: values,\n  })\n  loading.value = false\n  return d.name\n}\n\nasync function callInsertDoc() {\n  const doc = await call('frappe.client.insert', {\n    doc: {\n      doctype: 'Customer',\n      ..._customer.value,\n    },\n  })\n  loading.value = false\n  if (doc.name) {\n    capture('customer_created')\n    handleCustomerUpdate(doc)\n  }\n}\n\nfunction handleCustomerUpdate(doc, renamed = false) {\n  if (doc.name && (props.options.redirect || renamed)) {\n    router.push({\n      name: 'Customer',\n      params: { customerId: doc.name },\n    })\n  } else {\n    customer.value.reload?.()\n  }\n  show.value = false\n  props.options.afterInsert && props.options.afterInsert(doc)\n}\n\nconst dialogOptions = computed(() => {\n  let title = !editMode.value\n    ? __('New Customer')\n    : __(_customer.value.customer_name)\n  let size = detailMode.value ? '' : 'xl'\n  let actions = detailMode.value\n    ? []\n    : [\n        {\n          label: editMode.value ? __('Save') : __('Create'),\n          variant: 'solid',\n          onClick: () =>\n            editMode.value ? updateCustomer() : callInsertDoc(),\n        },\n      ]\n\n  return { title, size, actions }\n})\n\nconst fields = computed(() => {\n  let details = [\n    {\n      icon: CustomersIcon,\n      name: 'customer_name',\n      value: _customer.value.customer_name,\n    },\n    {\n      icon: WebsiteIcon,\n      name: 'website',\n      value: _customer.value.website,\n    },\n    {\n      icon: TerritoryIcon,\n      name: 'territory',\n      value: _customer.value.territory,\n    },\n    {\n      icon: MoneyIcon,\n      name: 'annual_revenue',\n      value: formatNumberIntoCurrency(\n        _customer.value.annual_revenue,\n        _customer.value.currency,\n      ),\n    },\n    {\n      icon: h(FeatherIcon, { name: 'hash', class: 'h-4 w-4' }),\n      name: 'no_of_employees',\n      value: _customer.value.no_of_employees,\n    },\n    {\n      icon: h(FeatherIcon, { name: 'briefcase', class: 'h-4 w-4' }),\n      name: 'industry',\n      value: _customer.value.industry,\n    },\n  ]\n\n  return details.filter((field) => field.value)\n})\n\nconst sections = createResource({\n  url: 'next_crm.ncrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout',\n  cache: ['quickEntryFields', 'Customer'],\n  params: { doctype: 'Customer', type: 'Quick Entry' },\n  auto: true,\n})\n\nconst filteredSections = computed(() => {\n  let allSections = sections.data || []\n  if (!allSections.length) return []\n\n  allSections.forEach((s) => {\n    s.fields.forEach((field) => {\n      if (field.name == 'address') {\n        field.create = (value, close) => {\n          _customer.value.address = value\n          _address.value = {}\n          showAddressModal.value = true\n          close()\n        }\n        field.edit = async (addr) => {\n          _address.value = await call('frappe.client.get', {\n            doctype: 'Address',\n            name: addr,\n          })\n          showAddressModal.value = true\n        }\n      }\n    })\n  })\n\n  return allSections\n})\n\nwatch(\n  () => show.value,\n  (value) => {\n    if (!value) return\n    editMode.value = false\n    detailMode.value = props.options.detailMode\n    nextTick(() => {\n      // TODO: Issue with FormControl\n      // title.value.el.focus()\n      doc.value = customer.value?.doc || customer.value || {}\n      _customer.value = { ...doc.value }\n      if (_customer.value.name) {\n        editMode.value = true\n      }\n    })\n  },\n)\n\nconst showQuickEntryModal = defineModel('quickEntry')\n\nfunction openQuickEntryModal() {\n  showQuickEntryModal.value = true\n  nextTick(() => {\n    show.value = false\n  })\n}\n</script>\n"],"names":["_hoisted_1","_hoisted_2","_createElementVNode","_hoisted_5","_hoisted_3","_cache","_hoisted_6","_hoisted_4","props","__props","isManager","usersStore","router","useRouter","show","_useModel","customer","loading","ref","detailMode","editMode","_address","_customer","showAddressModal","doc","updateCustomer","old","newOrg","nameChanged","otherFieldChanged","values","name","callRenameDoc","callSetValue","handleCustomerUpdate","d","call","_a","callInsertDoc","capture","renamed","_b","dialogOptions","computed","title","size","actions","fields","CustomersIcon","WebsiteIcon","TerritoryIcon","MoneyIcon","formatNumberIntoCurrency","h","FeatherIcon","field","sections","createResource","filteredSections","allSections","s","value","close","addr","watch","nextTick","showQuickEntryModal","openQuickEntryModal"],"mappings":"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"}