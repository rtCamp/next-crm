import{a as ge}from"./FadedScrollableDiv-10ee6cf2.js";import{D as he}from"./DetailsIcon-14f9b41c.js";import{u as be,A as xe,E as Ce,a as we,S as Ie,L as ke,b as Ve}from"./useActiveTabManager-3d8e42db.js";import{E as Oe}from"./Email2Icon-08867043.js";import{C as Se}from"./CommentIcon-0a334634.js";import{P as Y}from"./PhoneIcon-42af6989.js";import{T as $e}from"./TaskIcon-1948830b.js";import{N as Ae}from"./NoteModal-6fe04093.js";import{W as Te}from"./WhatsAppIcon-1b004e01.js";import{I as Ue}from"./IndicatorIcon-367a8d49.js";import{A as Ee}from"./ArrowUpRightIcon-c299f2a1.js";import{g as qe,S as Be,_ as De,a as je}from"./view-43ec0067.js";import{_ as Le}from"./LayoutHeader-72a3cdee.js";import{_ as Me}from"./CustomerModal-0ca69a84.js";import{_ as Ne}from"./AssignmentModal-759f92c3.js";import{s as Fe,_ as Pe}from"./statuses-6fc48ca5.js";import{C as Re}from"./ContactModal-35025f71.js";import{_ as ze}from"./views-5d4a0486.js";import{_ as Z}from"./Section-3c95fd43.js";import{_ as We}from"./CustomActions-d5b79d4f.js";import{g as Ge,e as h,s as He,i as Je,b as Ke}from"./index-b1bb6af7.js";import{i as Qe,c as Xe,w as Ye}from"./settings-9f3d7d3a.js";import{h as Ze,v as et,l as g,x as O,I as S,a as tt,j as ee,r as N,b as r,c as d,u as a,g as y,w as p,p as _,G as at,e as m,d as l,M as F,F as P,n as U,f as te,t as $,H as ae,B as ot}from"./index-8ca2d158.js";import{_ as st}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-28c0bac8.js";import{_ as oe}from"./Dropdown.vue_vue_type_script_setup_true_lang-dba778cd.js";import"./CalendarIcon-6dc7ec06.js";import"./callLog-6b45f0c6.js";import"./contacts-690888e4.js";import"./IconPicker-b2d84813.js";import"./FileUploader-e5eb09df.js";import"./LeadsIcon-81572691.js";import"./OpportunitiesIcon-89f01f41.js";import"./EmailTemplateModal-9a3ef12a.js";import"./TaskModal-9393661c.js";import"./Fields-02fbbc9b.js";import"./DatePicker-0e72d67e.js";import"./AddressModal-e11ac707.js";import"./QuickEntryModal-ebc5f118.js";import"./DragVerticalIcon-523c4542.js";import"./Switch.vue_vue_type_script_setup_true_lang-cbc97d13.js";import"./WebsiteIcon-326f696e.js";import"./CustomersIcon-c98fca89.js";const nt={class:"relative flex h-10.5 items-center justify-between gap-2 py-2.5 pl-2"},it={class:"absolute right-0"},rt={key:1,class:"flex h-12 items-center justify-between gap-2 border-b px-3 py-2.5"},lt={class:"flex items-center gap-2"},ut={key:2,class:"flex h-full overflow-hidden"},pt={key:0},dt={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},mt={class:"flex flex-col overflow-y-auto"},ct={key:0,class:"pr-2"},_t={key:1},ft={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},yt={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},vt=["onClick"],gt={class:"truncate"},ht={class:"flex items-center"},bt={class:"flex flex-col gap-1.5 text-base text-gray-800"},xt={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Ct={class:"flex items-center gap-3 p-1 py-1.5"},wt={key:0,class:"mx-2 h-px border-t border-gray-200"},It={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},ca={__name:"MobileOpportunoty",props:{opportunityId:{type:String,required:!0}},setup(se){const{$dialog:ne,$socket:ie}=Ge(),{statusOptions:re,getDealStatus:le}=Fe(),b=Ze(),A=et(),f=se,E=g([]),R=g([]),o=O({url:"/api/method/next_crm.api.opportunity.get_opportunity",params:{name:f.opportunityId},cache:["opportunity",f.opportunityId],onSuccess:async t=>{t.customer&&(q.update({params:{doctype:"Customer",name:t.customer}}),q.fetch());let e={doc:t,$dialog:ne,$socket:ie,router:A,updateField:k,createToast:h,deleteDoc:ye,resource:{opportunity:o,opportunityContacts:w,fieldsLayout:C},call:S};He(t);let s=await Je(t,e);E.value=s.actions||[],R.value=s.statuses||[]}}),q=O({url:"frappe.client.get",onSuccess:t=>o.data._customersObj=t});tt(()=>{o.data||o.fetch()});const B=g(!1),D=g(!1),T=g(!1),j=g({});function ue(t,e,s){e=Array.isArray(t)?"":e,!pe(t,e)&&O({url:"frappe.client.set_value",params:{doctype:"Opportunity",name:f.opportunityId,fieldname:t,value:e},auto:!0,onSuccess:()=>{o.reload(),B.value=!0,h({title:__("Opportunity updated"),icon:"check",iconClasses:"text-green-600"}),s==null||s()},onError:n=>{var I;h({title:__("Error updating opportunity"),text:__((I=n.messages)==null?void 0:I[0]),icon:"x",iconClasses:"text-red-600"})}})}function pe(t,e){var n;let s=o.data.fields_meta||{};return(n=s[t])!=null&&n.reqd&&!e?(h({title:__("Error Updating Opportunity"),text:__("{0} is a required field",[s[t].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const de=ee(()=>{var e;let t=[{label:__("Opportunities"),route:{name:"Opportunities"}}];if(b.query.view||b.query.viewType){let s=qe(b.query.view,b.query.viewType,"Opportunity");s&&t.push({label:__(s.label),icon:s.icon,route:{name:"Opportunities",params:{viewType:b.query.viewType},query:{view:b.query.view}}})}return t.push({label:((e=q.data)==null?void 0:e.name)||__("Untitled"),route:{name:"Opportunity",params:{opportunityId:o.data.name}}}),t}),L=ee(()=>[{name:"Details",label:__("Details"),icon:he,condition:()=>Qe.value},{name:"Activity",label:__("Activity"),icon:xe},{name:"Emails",label:__("Emails"),icon:Ce},{name:"Comments",label:__("Comments"),icon:Se},{name:"Calls",label:__("Calls"),icon:Y,condition:()=>Xe.value},{name:"Tasks",label:__("Tasks"),icon:$e},{name:"Notes",label:__("Notes"),icon:Ae},{name:"Attachments",label:__("Attachments"),icon:we},{name:"WhatsApp",label:__("WhatsApp"),icon:Te,condition:()=>Ye.value}].filter(e=>e.condition?e.condition():!0)),{tabIndex:x}=be(L,"lastOpportunityTab"),C=O({url:"next_crm.api.doc.get_sidebar_fields",cache:["fieldsLayout",f.opportunityId],params:{doctype:"Opportunity",name:f.opportunityId},auto:!0,transform:t=>me(t)});function me(t){return t.forEach(e=>{e.name!="contacts_section"&&e.fields.forEach(s=>{s.name=="customer"&&(s.create=(n,I)=>{j.value.customer_name=n,D.value=!0,I()},s.link=n=>A.push({name:"Customer",params:{customerId:n}}))})}),t}const M=g(!1),z=g({});function ce(t){let e=[{label:__("Delete"),icon:"trash-2",onClick:()=>_e(t)}];return t.is_primary||e.push({label:__("Set as Primary Contact"),icon:ot(je,{class:"h-4 w-4"}),onClick:()=>fe(t.name)}),e}async function W(t){await S("next_crm.overrides.opportunity.add_contact",{opportunity:f.opportunityId,contact:t})&&(w.reload(),h({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function _e(t){await S("next_crm.overrides.opportunity.remove_contact",{opportunity:f.opportunityId,contact:t})&&(w.reload(),h({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function fe(t){await S("next_crm.overrides.opportunity.set_primary_contact",{opportunity:f.opportunityId,contact:t})&&(w.reload(),h({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const w=O({url:"/api/method/next_crm.api.opportunity.get_opportunity_contacts",params:{name:f.opportunityId},cache:["opportunity_contacts",f.opportunityId],auto:!0,onSuccess:t=>{var s;let e=(s=C.data)==null?void 0:s.find(n=>n.name=="contacts_section");e&&(e.contacts=t.map(n=>({name:n.name,full_name:n.full_name,email:n.email,mobile_no:n.mobile_no,image:n.image,is_primary:n.is_primary,opened:!1})))}});function k(t,e,s){ue(t,e,()=>{o.data[t]=e,s==null||s()})}async function ye(t){await S("frappe.client.delete",{doctype:"Opportunity",name:t}),A.push({name:"Opportunities"})}return(t,e)=>{var G;const s=N("FeatherIcon"),n=N("Button"),I=N("Badge");return r(),d(P,null,[a(o).data?(r(),y(Le,{key:0},{default:p(()=>[m("header",nt,[l(a(st),{items:de.value},{prefix:p(({item:i})=>[i.icon?(r(),y(ge,{key:0,icon:i.icon,class:"mr-2 h-4"},null,8,["icon"])):_("",!0)]),_:1},8,["items"]),m("div",it,[l(a(oe),{options:a(re)("deal",k,R.value)},{default:p(({open:i})=>[l(n,{label:a(o).data.status,class:U(a(le)(a(o).data.status).colorClass)},{prefix:p(()=>[l(Ue)]),suffix:p(()=>[l(s,{name:i?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])])])]),_:1})):_("",!0),a(o).data?(r(),d("div",rt,[(r(),y(at(((G=a(o).data._assignedTo)==null?void 0:G.length)==1?"Button":"div"),null,{default:p(()=>[l(Pe,{avatars:a(o).data._assignedTo,onClick:e[0]||(e[0]=i=>T.value=!0)},null,8,["avatars"])]),_:1})),m("div",lt,[E.value?(r(),y(We,{key:0,actions:E.value},null,8,["actions"])):_("",!0)])])):_("",!0),a(o).data?(r(),d("div",ut,[l(a(De),{modelValue:a(x),"onUpdate:modelValue":e[7]||(e[7]=i=>F(x)?x.value=i:null),tabs:L.value,tablistClass:"!px-3",class:"overflow-auto"},{default:p(({tab:i})=>[i.name=="Details"?(r(),d("div",pt,[a(o).data.sla_status?(r(),y(Ie,{key:0,modelValue:a(o).data,"onUpdate:modelValue":e[1]||(e[1]=u=>a(o).data=u),onUpdateField:k},null,8,["modelValue"])):_("",!0),a(C).data?(r(),d("div",dt,[m("div",mt,[(r(!0),d(P,null,te(a(C).data,(u,H)=>(r(),d("div",{key:u.label,class:U(["flex flex-col px-2 py-3 sm:p-3",{"border-b":H!==a(C).data.length-1}])},[l(Z,{"is-opened":u.opened,label:u.label},{actions:p(()=>[u.contacts?(r(),d("div",ct,[l(ze,{value:"",doctype:"Contact",onChange:e[2]||(e[2]=v=>W(v)),onCreate:(v,V)=>{z.value={first_name:v,company_name:a(o).data.customer},M.value=!0,V()}},{target:p(({togglePopover:v})=>[l(n,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:V=>v()},null,8,["onClick"])]),_:1},8,["onCreate"])])):_("",!0)]),default:p(()=>{var v,V,J;return[u.fields?(r(),y(Be,{key:0,fields:u.fields,isLastSection:H==a(C).data.length-1,modelValue:a(o).data,"onUpdate:modelValue":e[3]||(e[3]=c=>a(o).data=c),onUpdate:k},null,8,["fields","isLastSection","modelValue"])):(r(),d("div",_t,[(v=a(w))!=null&&v.loading&&((J=(V=a(w))==null?void 0:V.data)==null?void 0:J.length)==0?(r(),d("div",ft,[l(ke,{class:"h-4 w-4"}),m("span",null,$(t.__("Loading...")),1)])):u.contacts.length?(r(!0),d(P,{key:1},te(u.contacts,(c,K)=>(r(),d("div",{key:c.name},[m("div",{class:U(["px-2 pb-2.5",[K==0?"pt-5":"pt-2.5"]])},[l(Z,{"is-opened":c.opened},{header:p(({opened:ve,toggle:Q})=>[m("div",yt,[m("div",{class:"flex h-7 items-center gap-2 truncate",onClick:X=>Q()},[l(a(Ke),{label:c.full_name,image:c.image,size:"md"},null,8,["label","image"]),m("div",gt,$(c.full_name),1),c.is_primary?(r(),y(I,{key:0,class:"ml-2",variant:"outline",label:t.__("Primary"),theme:"green"},null,8,["label"])):_("",!0)],8,vt),m("div",ht,[l(a(oe),{options:ce(c.name)},{default:p(()=>[l(n,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),l(n,{variant:"ghost",onClick:X=>a(A).push({name:"Contact",params:{contactId:c.name}})},{default:p(()=>[l(Ee,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),l(n,{variant:"ghost",onClick:X=>Q()},{default:p(()=>[l(s,{name:"chevron-right",class:U(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":ve}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:p(()=>[m("div",bt,[m("div",xt,[l(Oe,{class:"h-4 w-4"}),ae(" "+$(c.email),1)]),m("div",Ct,[l(Y,{class:"h-4 w-4"}),ae(" "+$(c.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),K!=u.contacts.length-1?(r(),d("div",wt)):_("",!0)]))),128)):(r(),d("div",It,$(t.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):_("",!0)])):(r(),y(Ve,{key:1,doctype:"Opportunity",tabs:L.value,reload:B.value,"onUpdate:reload":e[4]||(e[4]=u=>B.value=u),tabIndex:a(x),"onUpdate:tabIndex":e[5]||(e[5]=u=>F(x)?x.value=u:null),modelValue:a(o),"onUpdate:modelValue":e[6]||(e[6]=u=>F(o)?o.value=u:null)},null,8,["tabs","reload","tabIndex","modelValue"]))]),_:1},8,["modelValue","tabs"])])):_("",!0),l(Me,{modelValue:D.value,"onUpdate:modelValue":e[8]||(e[8]=i=>D.value=i),customer:j.value,"onUpdate:customer":e[9]||(e[9]=i=>j.value=i),options:{redirect:!1,afterInsert:i=>k("customer",i.name)}},null,8,["modelValue","customer","options"]),l(Re,{modelValue:M.value,"onUpdate:modelValue":e[10]||(e[10]=i=>M.value=i),contact:z.value,options:{redirect:!1,afterInsert:i=>W(i.name)}},null,8,["modelValue","contact","options"]),T.value?(r(),y(Ne,{key:3,modelValue:T.value,"onUpdate:modelValue":e[11]||(e[11]=i=>T.value=i),assignees:a(o).data._assignedTo,"onUpdate:assignees":e[12]||(e[12]=i=>a(o).data._assignedTo=i),doc:a(o).data,doctype:"Opportunity"},null,8,["modelValue","assignees","doc"])):_("",!0)],64)}}};export{ca as default};
//# sourceMappingURL=MobileOpportunoty-c8370dee.js.map
