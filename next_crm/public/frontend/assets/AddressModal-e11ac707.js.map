{"version":3,"file":"AddressModal-e11ac707.js","sources":["../../../../frontend/src/components/Modals/AddressModal.vue"],"sourcesContent":["<template>\n  <Dialog v-model=\"show\" :options=\"dialogOptions\">\n    <template #body>\n      <div class=\"bg-white px-4 pb-6 pt-5 sm:px-6\">\n        <div class=\"mb-5 flex items-center justify-between\">\n          <div>\n            <h3 class=\"text-2xl font-semibold leading-6 text-gray-900\">\n              {{ __(dialogOptions.title) || __('Untitled') }}\n            </h3>\n          </div>\n          <div class=\"flex items-center gap-1\">\n            <Button\n              v-if=\"isManager()\"\n              variant=\"ghost\"\n              class=\"w-7\"\n              @click=\"openQuickEntryModal\"\n            >\n              <EditIcon class=\"h-4 w-4\" />\n            </Button>\n            <Button variant=\"ghost\" class=\"w-7\" @click=\"show = false\">\n              <FeatherIcon name=\"x\" class=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n        <div v-if=\"sections.data\">\n          <Fields :sections=\"sections.data\" :data=\"_address\" />\n          <ErrorMessage class=\"mt-2\" :message=\"error\" />\n        </div>\n      </div>\n      <div class=\"px-4 pb-7 pt-4 sm:px-6\">\n        <div class=\"space-y-2\">\n          <Button\n            class=\"w-full\"\n            v-for=\"action in dialogOptions.actions\"\n            :key=\"action.label\"\n            v-bind=\"action\"\n            :label=\"__(action.label)\"\n            :loading=\"loading\"\n          />\n        </div>\n      </div>\n    </template>\n  </Dialog>\n  <QuickEntryModal\n    v-if=\"showQuickEntryModal\"\n    v-model=\"showQuickEntryModal\"\n    doctype=\"Address\"\n  />\n</template>\n\n<script setup>\nimport QuickEntryModal from '@/components/Modals/QuickEntryModal.vue'\nimport Fields from '@/components/Fields.vue'\nimport EditIcon from '@/components/Icons/EditIcon.vue'\nimport { usersStore } from '@/stores/users'\nimport { capture } from '@/telemetry'\nimport { call, FeatherIcon, createResource, ErrorMessage } from 'frappe-ui'\nimport { ref, nextTick, watch, computed } from 'vue'\n\nconst props = defineProps({\n  options: {\n    type: Object,\n    default: {\n      afterInsert: () => {},\n    },\n  },\n})\n\nconst { isManager } = usersStore()\n\nconst show = defineModel()\nconst address = defineModel('address')\n\nconst loading = ref(false)\nconst error = ref(null)\nconst title = ref(null)\nconst editMode = ref(false)\n\nlet _address = ref({\n  name: '',\n  address_title: '',\n  address_type: 'Billing',\n  address_line1: '',\n  address_line2: '',\n  city: '',\n  county: '',\n  state: '',\n  country: '',\n  pincode: '',\n})\n\nconst dialogOptions = computed(() => {\n  let title = !editMode.value\n    ? __('New Address')\n    : __(_address.value.address_title)\n  let size = 'xl'\n  let actions = [\n    {\n      label: editMode.value ? __('Save') : __('Create'),\n      variant: 'solid',\n      onClick: () =>\n        editMode.value ? updateAddress() : createAddress.submit(),\n    },\n  ]\n\n  return { title, size, actions }\n})\n\nconst sections = createResource({\n  url: 'next_crm.ncrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout',\n  cache: ['quickEntryFields', 'Address'],\n  params: { doctype: 'Address', type: 'Quick Entry' },\n  auto: true,\n})\n\nlet doc = ref({})\n\nfunction updateAddress() {\n  error.value = null\n  const old = { ...doc.value }\n  const newAddress = { ..._address.value }\n\n  const dirty = JSON.stringify(old) !== JSON.stringify(newAddress)\n  const values = newAddress\n\n  if (!dirty) {\n    show.value = false\n    return\n  }\n\n  loading.value = true\n  updateAddressValues.submit({\n    doctype: 'Address',\n    name: _address.value.name,\n    fieldname: values,\n  })\n}\n\nconst updateAddressValues = createResource({\n  url: 'frappe.client.set_value',\n  onSuccess(doc) {\n    loading.value = false\n    if (doc.name) {\n      handleAddressUpdate(doc)\n    }\n  },\n  onError(err) {\n    loading.value = false\n    error.value = err\n  },\n})\n\nconst createAddress = createResource({\n  url: 'frappe.client.insert',\n  makeParams() {\n    return {\n      doc: {\n        doctype: 'Address',\n        ..._address.value,\n      },\n    }\n  },\n  onSuccess(doc) {\n    loading.value = false\n    if (doc.name) {\n      capture('address_created')\n      handleAddressUpdate(doc)\n    }\n  },\n  onError(err) {\n    loading.value = false\n    error.value = err\n  },\n})\n\nfunction handleAddressUpdate(doc) {\n  show.value = false\n  props.options.afterInsert && props.options.afterInsert(doc)\n}\n\nwatch(\n  () => show.value,\n  (value) => {\n    if (!value) return\n    editMode.value = false\n    nextTick(() => {\n      // TODO: Issue with FormControl\n      // title.value.el.focus()\n      doc.value = address.value?.doc || address.value || {}\n      _address.value = { ...doc.value }\n      if (_address.value.name) {\n        editMode.value = true\n      }\n    })\n  },\n)\n\nconst showQuickEntryModal = ref(false)\n\nfunction openQuickEntryModal() {\n  showQuickEntryModal.value = true\n  nextTick(() => {\n    show.value = false\n  })\n}\n</script>\n"],"names":["props","__props","isManager","usersStore","show","_useModel","address","loading","ref","error","editMode","_address","dialogOptions","computed","title","size","actions","updateAddress","createAddress","sections","createResource","doc","old","newAddress","dirty","values","updateAddressValues","handleAddressUpdate","err","capture","watch","value","nextTick","_a","showQuickEntryModal","openQuickEntryModal"],"mappings":"i0BA2DA,MAAMA,EAAQC,EASR,CAAE,UAAAC,CAAW,EAAGC,EAAY,EAE5BC,EAAOC,gBAAY,EACnBC,EAAUD,EAAYJ,EAAA,SAAS,EAE/BM,EAAUC,EAAI,EAAK,EACnBC,EAAQD,EAAI,IAAI,EACRA,EAAI,IAAI,EACtB,MAAME,EAAWF,EAAI,EAAK,EAE1B,IAAIG,EAAWH,EAAI,CACjB,KAAM,GACN,cAAe,GACf,aAAc,UACd,cAAe,GACf,cAAe,GACf,KAAM,GACN,OAAQ,GACR,MAAO,GACP,QAAS,GACT,QAAS,EACX,CAAC,EAED,MAAMI,EAAgBC,EAAS,IAAM,CACnC,IAAIC,EAASJ,EAAS,MAElB,GAAGC,EAAS,MAAM,aAAa,EAD/B,GAAG,aAAa,EAEhBI,EAAO,KACPC,EAAU,CACZ,CACE,MAAON,EAAS,MAAQ,GAAG,MAAM,EAAI,GAAG,QAAQ,EAChD,QAAS,QACT,QAAS,IACPA,EAAS,MAAQO,IAAkBC,EAAc,OAAQ,CAC5D,CACF,EAED,MAAO,CAAE,MAAAJ,EAAO,KAAAC,EAAM,QAAAC,CAAS,CACjC,CAAC,EAEKG,EAAWC,EAAe,CAC9B,IAAK,8EACL,MAAO,CAAC,mBAAoB,SAAS,EACrC,OAAQ,CAAE,QAAS,UAAW,KAAM,aAAe,EACnD,KAAM,EACR,CAAC,EAED,IAAIC,EAAMb,EAAI,EAAE,EAEhB,SAASS,GAAgB,CACvBR,EAAM,MAAQ,KACd,MAAMa,EAAM,CAAE,GAAGD,EAAI,KAAO,EACtBE,EAAa,CAAE,GAAGZ,EAAS,KAAO,EAElCa,EAAQ,KAAK,UAAUF,CAAG,IAAM,KAAK,UAAUC,CAAU,EACzDE,EAASF,EAEf,GAAI,CAACC,EAAO,CACVpB,EAAK,MAAQ,GACb,MACD,CAEDG,EAAQ,MAAQ,GAChBmB,EAAoB,OAAO,CACzB,QAAS,UACT,KAAMf,EAAS,MAAM,KACrB,UAAWc,CACf,CAAG,CACH,CAEA,MAAMC,EAAsBN,EAAe,CACzC,IAAK,0BACL,UAAUC,EAAK,CACbd,EAAQ,MAAQ,GACZc,EAAI,MACNM,EAAoBN,CAAG,CAE1B,EACD,QAAQO,EAAK,CACXrB,EAAQ,MAAQ,GAChBE,EAAM,MAAQmB,CACf,CACH,CAAC,EAEKV,EAAgBE,EAAe,CACnC,IAAK,uBACL,YAAa,CACX,MAAO,CACL,IAAK,CACH,QAAS,UACT,GAAGT,EAAS,KACb,CACF,CACF,EACD,UAAUU,EAAK,CACbd,EAAQ,MAAQ,GACZc,EAAI,OACNQ,EAAQ,iBAAiB,EACzBF,EAAoBN,CAAG,EAE1B,EACD,QAAQO,EAAK,CACXrB,EAAQ,MAAQ,GAChBE,EAAM,MAAQmB,CACf,CACH,CAAC,EAED,SAASD,EAAoBN,EAAK,CAChCjB,EAAK,MAAQ,GACbJ,EAAM,QAAQ,aAAeA,EAAM,QAAQ,YAAYqB,CAAG,CAC5D,CAEAS,EACE,IAAM1B,EAAK,MACV2B,GAAU,CACJA,IACLrB,EAAS,MAAQ,GACjBsB,EAAS,IAAM,OAGbX,EAAI,QAAQY,EAAA3B,EAAQ,QAAR,YAAA2B,EAAe,MAAO3B,EAAQ,OAAS,CAAE,EACrDK,EAAS,MAAQ,CAAE,GAAGU,EAAI,KAAO,EAC7BV,EAAS,MAAM,OACjBD,EAAS,MAAQ,GAEzB,CAAK,EACF,CACH,EAEA,MAAMwB,EAAsB1B,EAAI,EAAK,EAErC,SAAS2B,GAAsB,CAC7BD,EAAoB,MAAQ,GAC5BF,EAAS,IAAM,CACb5B,EAAK,MAAQ,EACjB,CAAG,CACH"}