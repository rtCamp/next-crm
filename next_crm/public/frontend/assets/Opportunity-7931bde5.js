import{a as Ee}from"./FadedScrollableDiv-10ee6cf2.js";import{_ as Be,a as Ne}from"./SidePanelModal-7a4a2300.js";import{u as Me,_ as je,A as qe,E as Le,a as ie,b as ze,S as Fe,L as Pe}from"./useActiveTabManager-3d8e42db.js";import{_ as Re,E as We}from"./views-5d4a0486.js";import{E as re}from"./Email2Icon-08867043.js";import{C as De}from"./CommentIcon-0a334634.js";import{P as H}from"./PhoneIcon-42af6989.js";import{T as Ge}from"./TaskIcon-1948830b.js";import{N as He}from"./NoteModal-6fe04093.js";import{W as Ke}from"./WhatsAppIcon-1b004e01.js";import{I as Je}from"./IndicatorIcon-367a8d49.js";import{L as Qe}from"./LinkIcon-9e12ceb6.js";import{A as Xe}from"./ArrowUpRightIcon-c299f2a1.js";import{g as Ye,_ as Ze,S as et,a as tt}from"./view-43ec0067.js";import{_ as at}from"./LayoutHeader-72a3cdee.js";import{_ as ot}from"./CustomerModal-0ca69a84.js";import{_ as st}from"./AssignmentModal-759f92c3.js";import{s as nt,_ as lt}from"./statuses-6fc48ca5.js";import{C as it}from"./ContactModal-35025f71.js";import{_ as ue}from"./Section-3c95fd43.js";import{_ as rt}from"./CustomActions-d5b79d4f.js";import{g as ut,u as dt,e as h,s as pt,i as mt,j as ct,_ as O,b as de,k as M,o as _t}from"./index-b1bb6af7.js";import{c as pe,w as ft}from"./settings-9f3d7d3a.js";import{_ as yt,h as vt,v as gt,l as y,x as A,I as T,a as bt,o as xt,j as me,K as ht,r as K,b as u,c as _,u as a,g as f,w as l,p as m,d as o,M as J,F as Q,G as Ct,n as j,e as p,t as w,f as ce,H as _e,B as wt}from"./index-8ca2d158.js";import{_ as kt}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-28c0bac8.js";import{_ as fe}from"./Dropdown.vue_vue_type_script_setup_true_lang-dba778cd.js";import"./DragVerticalIcon-523c4542.js";import"./Switch.vue_vue_type_script_setup_true_lang-cbc97d13.js";import"./CalendarIcon-6dc7ec06.js";import"./callLog-6b45f0c6.js";import"./contacts-690888e4.js";import"./IconPicker-b2d84813.js";import"./FileUploader-e5eb09df.js";import"./LeadsIcon-81572691.js";import"./OpportunitiesIcon-89f01f41.js";import"./EmailTemplateModal-9a3ef12a.js";import"./TaskModal-9393661c.js";import"./Fields-02fbbc9b.js";import"./DatePicker-0e72d67e.js";import"./AddressModal-e11ac707.js";import"./QuickEntryModal-ebc5f118.js";import"./WebsiteIcon-326f696e.js";import"./CustomersIcon-c98fca89.js";const It={key:1,class:"flex h-full overflow-hidden"},Vt={class:"flex items-center justify-start gap-5 border-b p-5"},$t={class:"group relative size-12"},Ot={class:"flex flex-col gap-2.5 truncate"},St={class:"truncate text-2xl font-medium"},Ut={class:"flex gap-1.5"},At={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},Tt={class:"flex flex-col overflow-y-auto"},Et={key:0,class:"pr-2"},Bt={key:1},Nt={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},Mt={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},jt=["onClick"],qt={class:"truncate"},Lt={class:"flex items-center"},zt={class:"flex flex-col gap-1.5 text-base text-gray-800"},Ft={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Pt={class:"flex items-center gap-3 p-1 py-1.5"},Rt={key:0,class:"mx-2 h-px border-t border-gray-200"},Wt={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},Dt={__name:"Opportunity",props:{opportunityId:{type:String,required:!0}},setup(ye){const{$dialog:ve,$socket:q,makeCall:ge}=ut(),{statusOptions:be,getDealStatus:xe}=nt(),{isManager:he}=dt(),k=vt(),E=gt(),v=ye,L=y([]),X=y([]),n=A({url:"/api/method/next_crm.api.opportunity.get_opportunity",params:{name:v.opportunityId},cache:["opportunity",v.opportunityId],onSuccess:async t=>{t.customer&&(b.update({params:{doctype:"Customer",name:t.customer}}),b.fetch());let e={doc:t,$dialog:ve,$socket:q,router:E,updateField:S,createToast:h,deleteDoc:Ue,resource:{opportunity:n,opportunityContacts:g,fieldsLayout:V},call:T};pt(t);let i=await mt(t,e);L.value=i.actions||[],X.value=i.statuses||[]}}),b=A({url:"frappe.client.get",onSuccess:t=>n.data._customersObj=t});bt(()=>{if(q.on("crm_customer_created",()=>{h({title:__("Customer created successfully"),icon:"check",iconClasses:"text-green-600"})}),n.data){b.data=n.data._customersObj;return}n.fetch()}),xt(()=>{q.off("crm_customer_created")});const z=y(!1),F=y(!1),B=y(!1),N=y(!1),P=y(!1),R=y({});function Ce(t,e,i){e=Array.isArray(t)?"":e,!we(t,e)&&A({url:"frappe.client.set_value",params:{doctype:"Opportunity",name:v.opportunityId,fieldname:t,value:e},auto:!0,onSuccess:()=>{n.reload(),z.value=!0,h({title:__("Opportunity updated"),icon:"check",iconClasses:"text-green-600"}),i==null||i()},onError:d=>{var $;h({title:__("Error updating opportunity"),text:__(($=d.messages)==null?void 0:$[0]),icon:"x",iconClasses:"text-red-600"})}})}function we(t,e){var d;let i=n.data.fields_meta||{};return(d=i[t])!=null&&d.reqd&&!e?(h({title:__("Error Updating Opportunity"),text:__("{0} is a required field",[i[t].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const ke=me(()=>{var e;let t=[{label:__("Opportunities"),route:{name:"Opportunities"}}];if(k.query.view||k.query.viewType){let i=Ye(k.query.view,k.query.viewType,"Opportunity");i&&t.push({label:__(i.label),icon:i.icon,route:{name:"Opportunities",params:{viewType:k.query.viewType},query:{view:k.query.view}}})}return t.push({label:((e=b.data)==null?void 0:e.name)||__("Untitled"),route:{name:"Opportunity",params:{opportunityId:n.data.name}}}),t});ht(()=>{var t,e;return{title:((t=b.data)==null?void 0:t.name)||((e=n.data)==null?void 0:e.name)}});const W=me(()=>[{name:"Activity",label:__("Activity"),icon:qe},{name:"Emails",label:__("Emails"),icon:Le},{name:"Comments",label:__("Comments"),icon:De},{name:"Calls",label:__("Calls"),icon:H,condition:()=>pe.value},{name:"Tasks",label:__("Tasks"),icon:Ge},{name:"Notes",label:__("Notes"),icon:He},{name:"Attachments",label:__("Attachments"),icon:ie},{name:"WhatsApp",label:__("WhatsApp"),icon:Ke,condition:()=>ft.value}].filter(e=>e.condition?e.condition():!0)),{tabIndex:I}=Me(W,"lastOpportunityTab"),V=A({url:"next_crm.api.doc.get_sidebar_fields",cache:["fieldsLayout",v.opportunityId],params:{doctype:"Opportunity",name:v.opportunityId},auto:!0,transform:t=>Ie(t)});function Ie(t){return t.forEach(e=>{e.name!="contacts_section"&&e.fields.forEach(i=>{i.name=="customer"&&(i.create=(d,$)=>{R.value.customer_name=d,F.value=!0,$()},i.link=d=>E.push({name:"Customer",params:{customerId:d}}))})}),t}const D=y(!1),Y=y({});function Ve(t){let e=[{label:__("Remove"),icon:"trash-2",onClick:()=>$e(t.name)}];return t.is_primary||e.push({label:__("Set as Primary Contact"),icon:wt(tt,{class:"h-4 w-4"}),onClick:()=>Oe(t.name)}),e}async function Z(t){await T("next_crm.overrides.opportunity.add_contact",{opportunity:v.opportunityId,contact:t})&&(g.reload(),h({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function $e(t){await T("next_crm.overrides.opportunity.remove_contact",{opportunity:v.opportunityId,contact:t})&&(g.reload(),h({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function Oe(t){await T("next_crm.overrides.opportunity.set_primary_contact",{opportunity:v.opportunityId,contact:t})&&(g.reload(),h({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const g=A({url:"/api/method/next_crm.api.opportunity.get_opportunity_contacts",params:{name:v.opportunityId},cache:["opportunity_contacts",v.opportunityId],auto:!0,transform:t=>(t.forEach(e=>{e.opened=!1}),t)});function Se(){var i;let t=(i=g.data)==null?void 0:i.find(d=>d.is_primary),e=t.mobile_no||null;if(!t){M(__("No primary contact set"));return}if(!e){M(__("No mobile number set"));return}ge(e)}function S(t,e,i){Ce(t,e,()=>{n.data[t]=e,i==null||i()})}async function Ue(t){await T("frappe.client.delete",{doctype:"Opportunity",name:t}),E.push({name:"Opportunities"})}const G=y(null);function Ae(){G.value.emailBox.show=!0}return(t,e)=>{var ee;const i=K("FeatherIcon"),d=K("Button"),$=K("Badge");return u(),_(Q,null,[a(n).data?(u(),f(at,{key:0},{"left-header":l(()=>[o(a(kt),{items:ke.value},{prefix:l(({item:s})=>[s.icon?(u(),f(Ee,{key:0,icon:s.icon,class:"mr-2 h-4"},null,8,["icon"])):m("",!0)]),_:1},8,["items"])]),"right-header":l(()=>{var s;return[L.value?(u(),f(rt,{key:0,actions:L.value},null,8,["actions"])):m("",!0),(u(),f(Ct(((s=a(n).data._assignedTo)==null?void 0:s.length)==1?"Button":"div"),null,{default:l(()=>[o(lt,{avatars:a(n).data._assignedTo,onClick:e[0]||(e[0]=r=>B.value=!0)},null,8,["avatars"])]),_:1})),o(a(fe),{options:a(be)("deal",S,X.value)},{default:l(({open:r})=>[o(d,{label:a(n).data.status,class:j(a(xe)(a(n).data.status).colorClass)},{prefix:l(()=>[o(Je)]),suffix:l(()=>[o(i,{name:r?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])]}),_:1})):m("",!0),a(n).data?(u(),_("div",It,[o(a(Ze),{modelValue:a(I),"onUpdate:modelValue":e[4]||(e[4]=s=>J(I)?I.value=s:null),tabs:W.value},{default:l(()=>[o(ze,{ref_key:"activities",ref:G,doctype:"Opportunity",tabs:W.value,reload:z.value,"onUpdate:reload":e[1]||(e[1]=s=>z.value=s),tabIndex:a(I),"onUpdate:tabIndex":e[2]||(e[2]=s=>J(I)?I.value=s:null),modelValue:a(n),"onUpdate:modelValue":e[3]||(e[3]=s=>J(n)?n.value=s:null)},null,8,["tabs","reload","tabIndex","modelValue"])]),_:1},8,["modelValue","tabs"]),o(Be,{side:"right",class:"flex flex-col justify-between border-l"},{default:l(()=>{var s;return[p("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium",onClick:e[5]||(e[5]=r=>a(ct)(a(n).data.name))},w(t.__(a(n).data.name)),1),p("div",Vt,[o(a(O),{text:t.__("Customer logo")},{default:l(()=>{var r,C;return[p("div",$t,[o(a(de),{size:"3xl",class:"size-12",label:((r=a(b).data)==null?void 0:r.name)||t.__("Untitled"),image:(C=a(b).data)==null?void 0:C.image},null,8,["label","image"])])]}),_:1},8,["text"]),p("div",Ot,[o(a(O),{text:((s=a(b).data)==null?void 0:s.name)||t.__("Set an customer")},{default:l(()=>{var r;return[p("div",St,w(((r=a(b).data)==null?void 0:r.name)||t.__("Untitled")),1)]}),_:1},8,["text"]),p("div",Ut,[a(pe)?(u(),f(a(O),{key:0,text:t.__("Make a call")},{default:l(()=>[o(d,{class:"h-7 w-7",onClick:Se},{default:l(()=>[o(H,{class:"h-4 w-4"})]),_:1})]),_:1},8,["text"])):m("",!0),o(a(O),{text:t.__("Send an email")},{default:l(()=>[o(d,{class:"h-7 w-7"},{default:l(()=>[o(re,{class:"h-4 w-4",onClick:e[6]||(e[6]=r=>a(n).data.email?Ae():a(M)(t.__("No email set")))})]),_:1})]),_:1},8,["text"]),o(a(O),{text:t.__("Go to website")},{default:l(()=>[o(d,{class:"h-7 w-7"},{default:l(()=>[o(Qe,{class:"h-4 w-4",onClick:e[7]||(e[7]=r=>a(n).data.website?a(_t)(a(n).data.website):a(M)(t.__("No website set")))})]),_:1})]),_:1},8,["text"]),o(a(O),{text:t.__("Attach a file")},{default:l(()=>[o(d,{class:"size-7",onClick:e[8]||(e[8]=r=>P.value=!0)},{default:l(()=>[o(ie,{class:"size-4"})]),_:1})]),_:1},8,["text"])])])]),a(n).data.sla_status?(u(),f(Fe,{key:0,modelValue:a(n).data,"onUpdate:modelValue":e[9]||(e[9]=r=>a(n).data=r),onUpdateField:S},null,8,["modelValue"])):m("",!0),a(V).data?(u(),_("div",At,[p("div",Tt,[(u(!0),_(Q,null,ce(a(V).data,(r,C)=>(u(),_("div",{key:r.label,class:j(["section flex flex-col p-3",{"border-b":C!==a(V).data.length-1}])},[o(ue,{"is-opened":r.opened,label:r.label},{actions:l(()=>[r.contacts?(u(),_("div",Et,[o(Re,{value:"",doctype:"Contact",onChange:e[10]||(e[10]=x=>Z(x)),onCreate:(x,U)=>{Y.value={first_name:x,company_name:a(n).data.customer},D.value=!0,U()}},{target:l(({togglePopover:x})=>[o(d,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:U=>x()},null,8,["onClick"])]),_:1},8,["onCreate"])])):(!r.contacts&&C==1||C==0)&&a(he)()?(u(),f(d,{key:1,variant:"ghost",class:"w-7 mr-2",onClick:e[11]||(e[11]=x=>N.value=!0)},{default:l(()=>[o(We,{class:"h-4 w-4"})]),_:1})):m("",!0)]),default:l(()=>{var x,U,te,ae,oe;return[r.fields?(u(),f(et,{key:0,fields:r.fields,isLastSection:C==a(V).data.length-1,modelValue:a(n).data,"onUpdate:modelValue":e[12]||(e[12]=c=>a(n).data=c),onUpdate:S},null,8,["fields","isLastSection","modelValue"])):(u(),_("div",Bt,[(x=a(g))!=null&&x.loading&&((te=(U=a(g))==null?void 0:U.data)==null?void 0:te.length)==0?(u(),_("div",Nt,[o(Pe,{class:"h-4 w-4"}),p("span",null,w(t.__("Loading...")),1)])):(oe=(ae=a(g))==null?void 0:ae.data)!=null&&oe.length?(u(!0),_(Q,{key:1},ce(a(g).data,(c,se)=>(u(),_("div",{key:c.name},[p("div",{class:j(["px-2 pb-2.5",[se==0?"pt-5":"pt-2.5"]])},[o(ue,{"is-opened":c.opened},{header:l(({opened:Te,toggle:ne})=>[p("div",Mt,[p("div",{class:"flex h-7 items-center gap-2 truncate",onClick:le=>ne()},[o(a(de),{label:c.full_name,image:c.image,size:"md"},null,8,["label","image"]),p("div",qt,w(c.full_name),1),c.is_primary?(u(),f($,{key:0,class:"ml-2",variant:"outline",label:t.__("Primary"),theme:"green"},null,8,["label"])):m("",!0)],8,jt),p("div",Lt,[o(a(fe),{options:Ve(c)},{default:l(()=>[o(d,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),o(d,{variant:"ghost",onClick:le=>a(E).push({name:"Contact",params:{contactId:c.name}})},{default:l(()=>[o(Xe,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),o(d,{variant:"ghost",onClick:le=>ne()},{default:l(()=>[o(i,{name:"chevron-right",class:j(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":Te}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:l(()=>[p("div",zt,[p("div",Ft,[o(re,{class:"h-4 w-4"}),_e(" "+w(c.email),1)]),p("div",Pt,[o(H,{class:"h-4 w-4"}),_e(" "+w(c.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),se!=a(g).data.length-1?(u(),_("div",Rt)):m("",!0)]))),128)):(u(),_("div",Wt,w(t.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):m("",!0)]}),_:1})])):m("",!0),o(ot,{modelValue:F.value,"onUpdate:modelValue":e[13]||(e[13]=s=>F.value=s),customer:R.value,"onUpdate:customer":e[14]||(e[14]=s=>R.value=s),options:{redirect:!1,afterInsert:s=>S("customer",s.name)}},null,8,["modelValue","customer","options"]),o(it,{modelValue:D.value,"onUpdate:modelValue":e[15]||(e[15]=s=>D.value=s),contact:Y.value,options:{redirect:!1,afterInsert:s=>Z(s.name)}},null,8,["modelValue","contact","options"]),B.value?(u(),f(st,{key:2,modelValue:B.value,"onUpdate:modelValue":e[16]||(e[16]=s=>B.value=s),assignees:a(n).data._assignedTo,"onUpdate:assignees":e[17]||(e[17]=s=>a(n).data._assignedTo=s),doc:a(n).data,doctype:"Opportunity"},null,8,["modelValue","assignees","doc"])):m("",!0),N.value?(u(),f(Ne,{key:3,modelValue:N.value,"onUpdate:modelValue":e[18]||(e[18]=s=>N.value=s),doctype:"Opportunity",onReload:e[19]||(e[19]=()=>a(V).reload())},null,8,["modelValue"])):m("",!0),(ee=a(n).data)!=null&&ee.name?(u(),f(je,{key:4,modelValue:P.value,"onUpdate:modelValue":e[20]||(e[20]=s=>P.value=s),doctype:"Opportunity",docname:a(n).data.name,onAfter:e[21]||(e[21]=()=>{var s,r;(r=(s=G.value)==null?void 0:s.all_activities)==null||r.reload(),t.changeTabTo("attachments")})},null,8,["modelValue","docname"])):m("",!0)],64)}}},Na=yt(Dt,[["__scopeId","data-v-cd083e78"]]);export{Na as default};
//# sourceMappingURL=Opportunity-7931bde5.js.map
